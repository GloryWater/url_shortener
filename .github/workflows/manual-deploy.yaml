# Manual Deploy Workflow - Deploy on demand to any environment
name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to deploy (branch, tag, commit SHA)'
        required: true
        default: 'main'
        type: string

      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

      skip_tests:
        description: 'Skip CI tests (use with caution!)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

      run_migrations:
        description: 'Run database migrations'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

      restart_services:
        description: 'Restart all services'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

concurrency:
  group: ${{ github.workflow }}-${{ inputs.environment }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.12"
  UV_VERSION: "latest"
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================
  # Optional: Run Tests
  # ===========================================
  test:
    name: Run Tests (Optional)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: inputs.skip_tests == 'false'

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: ${{ env.UV_VERSION }}
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: uv sync --extra dev --frozen

      - name: Run Alembic migrations
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
        run: uv run alembic upgrade head

      - name: Run pytest
        env:
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          SECRET_KEY: test-secret-key-for-ci-only
          ENVIRONMENT: testing
        run: uv run pytest --cov=src --cov-fail-under=70 -v

  # ===========================================
  # Build Docker Image
  # ===========================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [test]
    if: always() && (needs.test.result == 'success' || needs.test.result == 'skipped')
    permissions:
      contents: read
      packages: write

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ inputs.environment }}-${{ github.run_number }}
            type=raw,value=${{ inputs.environment }}-latest,enable=${{ inputs.environment == 'production' }}
            type=ref,event=branch
            type=sha,prefix=,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          build-args: |
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
            ENVIRONMENT=${{ inputs.environment }}

  # ===========================================
  # Deploy to Server
  # ===========================================
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build]
    environment:
      name: ${{ inputs.environment }}
      url: ${{ vars.SERVER_URL || 'http://localhost:8001' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via SSH
        env:
          SERVER_USER: ${{ secrets.SERVER_USERNAME || vars.SERVER_USERNAME }}
          SERVER_HOST: ${{ secrets.SERVER_HOST || vars.SERVER_HOST }}
          DEPLOY_PATH: ${{ vars.DEPLOY_PATH || '~/url-shortener' }}
          IMAGE_TAG: ${{ inputs.environment }}-${{ github.run_number }}
          RESTART_SERVICES: ${{ inputs.restart_services }}
          RUN_MIGRATIONS: ${{ inputs.run_migrations }}
        run: |
          echo "ðŸš€ Starting manual deployment to ${{ inputs.environment }}..."
          echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          echo "ðŸ”§ Run migrations: $RUN_MIGRATIONS"
          echo "ðŸ”„ Restart services: $RESTART_SERVICES"

          ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'ENDSSH'
            set -e

            echo "ðŸ“¦ Pulling Docker image..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG

            cd $DEPLOY_PATH

            if [ "$RESTART_SERVICES" = "true" ]; then
              echo "ðŸ›‘ Stopping services..."
              docker-compose down --remove-orphans || true

              echo "ðŸ”„ Starting services with new image..."
              docker-compose up -d --force-recreate
            else
              echo "ðŸ”„ Updating services without full restart..."
              docker-compose up -d
            fi

            if [ "$RUN_MIGRATIONS" = "true" ]; then
              echo "â³ Waiting for database to be ready..."
              sleep 5
              echo "ðŸ—„ï¸ Running database migrations..."
              docker-compose exec -T url-shortener uv run alembic upgrade head || echo "âš ï¸ Migration step completed"
            fi

            echo "ðŸ—‘ï¸ Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true

            echo "ðŸ“‹ Container status:"
            docker-compose ps

            echo "âœ… Deployment completed!"
          ENDSSH

      - name: Health check
        run: |
          echo "ðŸ¥ Running health check..."
          ssh -o StrictHostKeyChecking=no "$SERVER_USER@$SERVER_HOST" << 'ENDSSH' || true
            echo "Checking API health endpoint..."
            curl -sf http://localhost:8001/health && echo "âœ… Health check passed" || echo "âš ï¸ Health check pending"

            echo "Checking root endpoint..."
            curl -sf http://localhost:8001/ && echo "âœ… Root endpoint OK" || echo "âš ï¸ Root endpoint pending"
          ENDSSH

      - name: Deployment summary
        run: |
          echo "## âœ… Manual Deployment Complete"
          echo ""
          echo "| Parameter | Value |"
          echo "|-----------|-------|"
          echo "| Environment | ${{ inputs.environment }} |"
          echo "| Git Ref | ${{ inputs.ref }} |"
          echo "| Image Tag | ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ inputs.environment }}-${{ github.run_number }} |"
          echo "| Run ID | ${{ github.run_number }} |"
          echo ""
          echo "Deployment to **${{ inputs.environment }}** completed successfully! ðŸŽ‰"
